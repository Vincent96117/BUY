<!DOCTYPE html>
<html>
<head>
    <title>V2.6 æ——è‰¦å…¨èƒ½ç‰ˆ - é‹¼éµæŒ‡æ®å®˜</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: "Microsoft JhengHei", sans-serif; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; background: #111; }
        th, td { padding: 12px; border: 1px solid #222; text-align: left; }
        th { background: #1a1a1a; color: #888; font-size: 12px; }
        .SCAN { color: #555; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255, 235, 59, 0.1); }
        .ENTRY { color: #fff; background: #d32f2f; font-weight: bold; animation: pulse 0.8s infinite; }
        .HOLD { color: #00ff00; font-weight: bold; background: rgba(0, 255, 0, 0.05); }
        .timer { font-family: monospace; color: #00ffff; margin-left: 8px; font-size: 11px; }
        .pinned { background: #2a2a00 !important; border-left: 4px solid #ffeb3b !important; }
        .pin-btn { cursor: pointer; margin-right: 8px; font-size: 18px; color: #444; }
        .pin-active { color: #ffeb3b !important; }
        @keyframes pulse { 0% { background: #d32f2f; } 50% { background: #ff5252; } 100% { background: #d32f2f; } }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; background: #d32f2f; color: white; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div style="font-size: 18px; font-weight: bold; color: #ff4444;">IRON COMMANDER V2.6</div>
        <button id="startBtn" onclick="toggleSystem()">ğŸš€ å•Ÿå‹•å¼•æ“</button>
        <div id="statusUpdate" style="margin-left: auto; color: #00ffff;">ç³»çµ±å°±ç·’ | æ’é™¤ BTC/ETH/SOL/XRP/BNB/BNX</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>é‡˜é¸/æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3æ—¥é«˜</th>
                <th>è·é›¢ %</th>
                <th>è³‡è²» (Fund)</th>
                <th>OI 1m è®Šå‹•</th>
                <th>ç‹€æ…‹ (ä¸Šæ¦œæ™‚é–“)</th>
                <th>å»ºè­°</th>
            </tr>
        </thead>
        <tbody id="radarBody"></tbody>
    </table>

<script>
    const BARK_KEY = "E96538f9eaef0eaec0fe65be1e6dc3738e08122150839671e3f654cd81633dcd";
    const BLACKLIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'];
    
    let isRunning = false;
    let historyOI = {}; 
    let highPriceMap = {}; 
    let notifiedStatus = {}; 
    let startTimeMap = {}; 
    let pinnedList = new Set(); 
    let lastDataCache = [];

    async function sendBark(title, body) {
        const url = `https://api.day.app/${BARK_KEY}/${encodeURIComponent(title)}/${encodeURIComponent(body)}?group=Trading&isArchive=1`;
        fetch(url, { mode: 'no-cors' }).catch(e => console.error("Bark Fail"));
    }

    async function getThreeDayHigh(symbol) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=4h&limit=18`);
            const klines = await res.json();
            return Math.max(...klines.map(kl => parseFloat(kl[2])));
        } catch (e) { return null; }
    }

    function togglePin(symbol) {
        if (pinnedList.has(symbol)) pinnedList.delete(symbol);
        else pinnedList.add(symbol);
        renderTable(lastDataCache);
    }

    async function fetchData() {
        if (!isRunning) return;
        try {
            const [pRes, fRes, tRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr')
            ]);
            
            const prices = await pRes.json();
            const funds = await fRes.json();
            const tickers = await tRes.json();
            let displayData = [];

            for (let f of funds) {
                // 1. åŸºæœ¬éæ¿¾ (çµå°¾ä¸æ˜¯ USDT æˆ–åœ¨é»‘åå–®)
                if (!f.symbol.endsWith('USDT') || BLACKLIST.includes(f.symbol)) continue;
                
                const fundRate = parseFloat(f.lastFundingRate);
                const curPrice = parseFloat(prices.find(p => p.symbol === f.symbol).price);
                
                // 2. ç²å– 3 æ—¥é«˜é»
                if (!highPriceMap[f.symbol]) highPriceMap[f.symbol] = await getThreeDayHigh(f.symbol);
                const highVal = highPriceMap[f.symbol] || curPrice;

                // 3. è¨ˆç®—æ•¸æ“š
                const dist = (((highVal - curPrice) / highVal) * 100).toFixed(2);
                const ticker = tickers.find(t => t.symbol === f.symbol);
                const currentOI = ticker ? parseFloat(ticker.volume) : 0;
                if (!historyOI[f.symbol]) historyOI[f.symbol] = currentOI;
                const oiChange = (((currentOI - historyOI[f.symbol]) / historyOI[f.symbol]) * 100).toFixed(2);
                historyOI[f.symbol] = currentOI;

                // 4. åˆ¤å®šç‹€æ…‹ (è³‡è²»æ­£è²  0.05 ä¸” è·é›¢é”æ¨™)
                let stCmd = "SCAN";
                const fundOk = Math.abs(fundRate) >= 0.0005;

                if (fundOk) {
                    if (dist <= 1.5 && dist > 0) stCmd = "READY";
                    if (curPrice >= highVal && oiChange > 1.0) stCmd = "ENTRY";
                    else if (dist <= 1.5 && oiChange > 5.0) stCmd = "ENTRY";
                    else if (curPrice >= highVal) stCmd = "HOLD";
                }

                // 5. è™•ç†æ¨æ’­èˆ‡è¨ˆæ™‚
                if (stCmd !== "SCAN") {
                    if (!startTimeMap[f.symbol]) startTimeMap[f.symbol] = Date.now();
                    if (notifiedStatus[f.symbol] !== stCmd) {
                        sendBark(`${stCmd} ${f.symbol}`, `D:${dist}% F:${(fundRate*100).toFixed(2)}%`);
                        notifiedStatus[f.symbol] = stCmd;
                    }
                } else {
                    startTimeMap[f.symbol] = null;
                    notifiedStatus[f.symbol] = "SCAN";
                }

                displayData.push({ symbol: f.symbol, curPrice, highVal, dist, fundRate: (fundRate*100).toFixed(4), oiChange, stCmd });
            }
            lastDataCache = displayData;
            renderTable(displayData);
        } catch (e) { console.error("å¼•æ“ç•°å¸¸"); }
    }

    function renderTable(data) {
        const body = document.getElementById('radarBody');
        // æ’åºï¼šé‡˜é¸ > ç‹€æ…‹(READY/ENTRY/HOLD) > è·é›¢
        const sorted = [...data].sort((a, b) => {
            const aP = pinnedList.has(a.symbol) ? 1 : 0;
            const bP = pinnedList.has(b.symbol) ? 1 : 0;
            if (aP !== bP) return bP - aP;
            
            const stateOrder = { "ENTRY": 3, "HOLD": 2, "READY": 1, "SCAN": 0 };
            if (stateOrder[a.stCmd] !== stateOrder[b.stCmd]) return stateOrder[b.stCmd] - stateOrder[a.stCmd];
            
            return a.dist - b.dist;
        });

        body.innerHTML = sorted.map(c => {
            const fundColor = Math.abs(parseFloat(c.fundRate)) >= 0.05 ? (c.fundRate < 0 ? '#ff00ff' : '#00ffff') : '#555';
            const timeStr = startTimeMap[c.symbol] ? Math.floor((Date.now()-startTimeMap[c.symbol])/1000) : 0;
            const m = Math.floor(timeStr/60).toString().padStart(2,'0');
            const s = (timeStr%60).toString().padStart(2,'0');
            
            return `
            <tr class="${pinnedList.has(c.symbol) ? 'pinned' : ''}">
                <td><span class="pin-btn ${pinnedList.has(c.symbol)?'pin-active':''}" onclick="togglePin('${c.symbol}')">ğŸ“Œ</span><b>${c.symbol}</b></td>
                <td>${c.curPrice.toFixed(4)} / ${c.highVal.toFixed(4)}</td>
                <td>${c.dist}%</td>
                <td style="color:${fundColor}">${c.fundRate}%</td>
                <td style="color:#ff4444">${c.oiChange}%</td>
                <td class="${c.stCmd}">${c.stCmd} ${c.stCmd!=='SCAN'?`<span class="timer">${m}:${s}</span>`:''}</td>
                <td>${c.stCmd==='READY'?'æº–å‚™ä¼æ“Š':c.stCmd==='ENTRY'?'åŸ·è¡Œçµæ®º':'-'}</td>
            </tr>`;
        }).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢ç›£æ§" : "ğŸš€ å•Ÿå‹•å¼•æ“";
        if (isRunning) setInterval(fetchData, 3000);
    }
</script>
</body>
</html>
