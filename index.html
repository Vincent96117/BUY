<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>V178-X é‹¼éµæŒ‡æ®å®˜ V3.1 (1.9.7 æ¼”ç®—æ³•å›æ­¸)</title>
    <style>
        :root { --bg: #0b0e11; --card: #181a20; --ready: #f0b90b; --entry: #f6465d; --text: #eaecef; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .control-panel { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; align-items: end; }
        label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        input { background: #333; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .audio-btn { background: var(--ready); color: #000; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; height: 38px; }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 10px; overflow: hidden; }
        th { background: #1e2329; color: #848e9c; padding: 12px 8px; font-size: 11px; text-align: left; }
        td { padding: 10px 8px; border-bottom: 1px solid #2b2f36; }
        .manual-locked { background: rgba(246, 70, 93, 0.12) !important; border-left: 5px solid var(--entry) !important; }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; }
        .READY { background: rgba(240, 185, 11, 0.3); color: var(--ready); border: 1px solid var(--ready); animation: flash 0.8s infinite; }
        .ENTRY { background: var(--entry); color: #fff; animation: pulse 0.4s infinite alternate; }
        .SCAN { color: #848e9c; border: 1px solid #444; }
        .time-tag { font-size: 10px; color: #aaa; display: block; margin-top: 2px; }
        .fund-warn { color: #00ffff; text-shadow: 0 0 5px #00ffff; font-weight: bold; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
    </style>
</head>
<body>
<div class="container">
    <div class="control-panel">
        <div><label>è‡ªè¨‚å¤©æ•¸</label><input type="number" id="lookbackDays" value="7"></div>
        <div><label>è³‡è²»é–€æª» (%)</label><input type="number" id="fundThreshold" value="-0.02" step="0.01"></div>
        <div><label>æˆäº¤éæ¿¾ (M)</label><input type="number" id="volLimit" value="5"></div>
        <div><label>éŸ³æ•ˆé–‹é—œ</label><button id="enableAudio" class="audio-btn">ğŸ“¢ å•Ÿå‹•ç›£æ§</button></div>
    </div>
    <table>
        <thead><tr><th>å¹£ç¨® (é–å®š)</th><th>å‰é«˜/ç•¶å‰åƒ¹</th><th>ç‡ˆè™Ÿ (æ™‚é–“)</th><th>è³‡è²»</th><th>å¼•åŠ›è·é›¢ â†“</th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script>
    // ä¾æ“šä½ çš„è¦æ±‚æ’é™¤ç‰¹å®šå¤§å¹£
    const blacklist = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT", "DOGEUSDT", "ADAUSDT", "TRXUSDT", "AVAXUSDT", "DOTUSDT", "SHIBUSDT", "TONUSDT", "LINKUSDT", "BCHUSDT", "NEARUSDT", "MATICUSDT", "LTCUSDT", "PEPEUSDT", "UNIUSDT", "ICPUSDT", "RENDERUSDT", "APTUSDT", "HBARUSDT", "ARBUSDT", "SUIUSDT"];
    let audioEnabled = false, lockedSymbols = {};
    const readyAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    const entryAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_short.ogg');

    document.getElementById('enableAudio').onclick = function() {
        audioEnabled = !audioEnabled;
        this.innerText = audioEnabled ? "âœ… ç›£æ§ä¸­ (7s)" : "ğŸ“¢ å•Ÿå‹•ç›£æ§";
        readyAudio.volume = 0; readyAudio.play(); entryAudio.volume = 0; entryAudio.play();
        setTimeout(() => { readyAudio.volume = 1; entryAudio.volume = 1; }, 500);
    };

    function toggleLock(s) {
        if (lockedSymbols[s]) delete lockedSymbols[s];
        else lockedSymbols[s] = { time: new Date().toLocaleTimeString(), manual: true };
        update();
    }

    async function update() {
        try {
            const days = parseInt(document.getElementById('lookbackDays').value) || 7;
            const fundLimit = parseFloat(document.getElementById('fundThreshold').value);
            const volMin = parseFloat(document.getElementById('volLimit').value) * 1000000;
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const data = await r.json();
            
            let coinData = [];
            let playType = null;

            // å›æ­¸ V1.9.7 çš„å»£åº¦ï¼Œä¸å› ç‚ºè³‡è²»è¸¢å¹£
            const filteredTickers = data.filter(x => x.symbol.endsWith('USDT') && !blacklist.includes(x.symbol))
                                      .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 100);

            for (let t of filteredTickers) {
                const vol = parseFloat(t.quoteVolume);
                if (vol < volMin && !lockedSymbols[t.symbol]) continue;

                const fundR = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${t.symbol}`);
                const fundD = await fundR.json();
                const fund = (parseFloat(fundD.lastFundingRate) * 100).toFixed(4);

                const limit = days * 6; 
                const kR = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=4h&limit=${limit + 1}`);
                const k = await kR.json();
                if(!k || k.length < 5) continue;
                
                const highVal = Math.max(...k.slice(0, limit).map(x => parseFloat(x[2])));
                const curPrice = parseFloat(t.lastPrice);
                const dist = ((highVal - curPrice) / curPrice * 100);

                // --- æ‹”æ‰å¼•åŠ›è·é›¢ç‚º 0 çš„æ­»å¹£ (é™¤éçªç ´è®Šæˆ ENTRY) ---
                if (Math.abs(dist) < 0.00001 && curPrice <= highVal && !lockedSymbols[t.symbol]) continue;

                // --- V1.9.7 æ ¸å¿ƒç®—æ³•å›æ­¸ ---
                let st = "SCAN";
                // 1. çªç ´å‰é«˜ï¼šENTRY
                if (curPrice > highVal) {
                    st = "ENTRY";
                    // åªæœ‰è³‡è²»é”æ¨™æ‰éŸ¿è­¦å ±
                    if (parseFloat(fund) <= fundLimit) playType = 'ENTRY';
                } 
                // 2. å¼•åŠ›è·é›¢ < 1.5%ï¼šREADY
                else if (dist < 1.5 && dist > -0.5) {
                    st = "READY";
                    // åªæœ‰è³‡è²»é”æ¨™æ‰éŸ¿è­¦å ±
                    if (parseFloat(fund) <= fundLimit && playType !== 'ENTRY') playType = 'READY';
                }

                // è‡ªå‹•é–å®šå‰›è®ŠåŒ–çš„æ¨™çš„
                if ((st === "READY" || st === "ENTRY") && !lockedSymbols[t.symbol]) {
                    lockedSymbols[t.symbol] = { time: new Date().toLocaleTimeString(), manual: false };
                }
                if (lockedSymbols[t.symbol]) lockedSymbols[t.symbol].lastSt = st;
                
                coinData.push({ s: t.symbol, highVal, curPrice, dist, fund, st });
            }

            if (audioEnabled && playType) {
                const a = (playType === 'ENTRY') ? entryAudio : readyAudio;
                a.currentTime = 0; a.play().catch(()=>{});
            }

            // æ’åºï¼šé–å®šå„ªå…ˆ > è·é›¢
            coinData.sort((a,b) => (lockedSymbols[b.s]?1:0) - (lockedSymbols[a.s]?1:0) || a.dist - b.dist);

            const body = document.getElementById('list'); body.innerHTML = '';
            for (let c of coinData.slice(0, 45)) {
                const lock = lockedSymbols[c.s];
                // è³‡è²»æ­£è²  0.05 è­¦å‘Š
                const fundClass = Math.abs(parseFloat(c.fund)) >= 0.05 ? 'fund-warn' : '';
                const displaySt = lock ? lock.lastSt : c.st;
                
                body.insertAdjacentHTML('beforeend', `
                    <tr class="${lock?.manual ? 'manual-locked' : ''}">
                        <td><b style="cursor:pointer; text-decoration:underline" onclick="toggleLock('${c.s}')">${c.s.replace('USDT','')}</b></td>
                        <td><div style="font-size:10px;color:#666">${days}D H: ${c.highVal}</div><b>${c.curPrice}</b></td>
                        <td><span class="status-badge ${displaySt}">${displaySt}</span>
                            ${lock ? `<span class="time-tag">â± ${lock.time}</span>` : ''}</td>
                        <td class="${fundClass}">${c.fund}%</td>
                        <td style="color:${c.dist<1.5?'#f0b90b':''}; font-weight:bold">${c.dist.toFixed(2)}%</td>
                    </tr>
                `);
            }
        } catch (e) {}
    }
    setInterval(update, 7000); 
    update();
</script>
</body>
</html>
