<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä¸‰äººçµæ®ºåœ˜ V3.2-Ultimate (å‹•æ…‹æ­¢ç›ˆèˆ‡æ¨æ’­ç‰ˆ)</title>
    <style>
        :root { --bg: #0b0e11; --card: #181a20; --ready: #f0b90b; --entry: #f6465d; --hold: #2ebd85; --scan: #474d57; --text: #eaecef; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 10px; font-size: 13px; }
        .container { max-width: 1300px; margin: 0 auto; }
        .control-panel { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        .audio-btn { background: var(--ready); color: #000; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 10px; overflow: hidden; }
        th { background: #1e2329; color: #848e9c; padding: 12px 8px; font-size: 11px; text-align: left; }
        td { padding: 12px 8px; border-bottom: 1px solid #2b2f36; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .READY { background: rgba(240, 185, 11, 0.2); color: var(--ready); border: 1px solid var(--ready); }
        .ENTRY { background: var(--entry); color: #fff; box-shadow: 0 0 10px var(--entry); animation: pulse 0.5s infinite alternate; }
        .HOLD { background: var(--hold); color: #fff; }
        .SCAN { color: var(--scan); }
        .fund-warn { color: #00ffff; text-shadow: 0 0 8px #00ffff; font-weight: bold; }
        .tp-label { color: #2ebd85; font-weight: bold; margin-left: 6px; font-family: monospace; }
        .timer { font-family: monospace; color: #f0b90b; font-size: 11px; margin-left: 5px; }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
        .oi-up { color: #2ebd85; font-weight: bold; }
        .oi-down { color: #f6465d; }
    </style>
</head>
<body>

<div class="container">
    <div class="control-panel">
        <div><label>è¿½è¹¤å¤©æ•¸</label><select id="lookbackDays"><option value="3" selected>3å¤©</option><option value="7">7å¤©</option></select></div>
        <div><label>è³‡è²»é–€æª» (%)</label><input type="number" id="fundThreshold" value="-0.02" step="0.01"></div>
        <div><button id="enableAudio" class="audio-btn">ğŸ“¢ å•Ÿå‹•ç›£æ§èˆ‡æ¨æ’­</button></div>
        <div style="color:#888; font-size:11px; text-align:right">ä¸Šæ¬¡æƒæ: <span id="lastUpdateTime">--:--:--</span></div>
    </div>
    <table>
        <thead><tr><th>å¹£ç¨®</th><th>åƒ¹æ ¼ (å‰é«˜)</th><th>ç‹€æ…‹ (åŸå›  / æ™‚é–“)</th><th>è³‡è²» (5mè¶¨å‹¢)</th><th>æŒå€‰ OI (1mè®Šå‹• / TPç›®æ¨™)</th><th>å¼•åŠ›</th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script>
    const blacklist = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];
    let audioEnabled = false;
    let historyData = {}; 
    let statusTimestamps = {}; 
    let entryPrices = {}; 
    let lastKnownTP = {}; 

    const alertAudio = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1100-modern.mp3');

    document.getElementById('enableAudio').addEventListener('click', function() {
        audioEnabled = !audioEnabled;
        this.innerText = audioEnabled ? "âœ… ç›£æ§æ¨æ’­ä¸­" : "ğŸ“¢ å•Ÿå‹•ç›£æ§èˆ‡æ¨æ’­";
        if (Notification.permission !== "granted") Notification.requestPermission();
    });

    async function update() {
        try {
            const days = parseInt(document.getElementById('lookbackDays').value);
            const fundLimit = parseFloat(document.getElementById('fundThreshold').value);
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const tickers = await r.json();
            const active = tickers.filter(x => x.symbol.endsWith('USDT') && !blacklist.includes(x.symbol) && parseFloat(x.quoteVolume) > 5000000)
                                 .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 50);

            document.getElementById('lastUpdateTime').innerText = new Date().toLocaleTimeString();

            const promises = active.map(async (t) => {
                const [fundR, kR, oiR] = await Promise.all([
                    fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${t.symbol}`).then(res => res.json()),
                    fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=4h&limit=${(days*6)+1}`).then(res => res.json()),
                    fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${t.symbol}`).then(res => res.json())
                ]);

                const curPrice = parseFloat(t.lastPrice);
                const fund = parseFloat(fundR.lastFundingRate) * 100;
                const oi = parseFloat(oiR.openInterest);
                const highVal = Math.max(...kR.slice(0, days*6).map(k => parseFloat(k[2])));
                const dist = ((highVal - curPrice) / curPrice * 100);

                if (!historyData[t.symbol]) historyData[t.symbol] = [];
                historyData[t.symbol].push({ fund, oi });
                if (historyData[t.symbol].length > 20) historyData[t.symbol].shift(); // æ»¾å‹•5åˆ†é˜æ•¸æ“š

                const old = historyData[t.symbol][0];
                const oiChange = ((oi - old.oi) / old.oi * 100);
                const fundDelta = fund - old.fund; 
                const fundOk = fund <= fundLimit;

                let stCmd = "SCAN", reason = "æƒæä¸­";
                if (curPrice > highVal && fundOk) {
                    if (oiChange > 1.0) { stCmd = "ENTRY"; reason = "çµæ§‹çªç ´"; }
                    else { stCmd = "HOLD"; reason = "èƒ½é‡çºŒèˆª"; }
                } else if (dist < 1.5 && fundOk) {
                    if (oiChange > 5.0) { stCmd = "ENTRY"; reason = "ä¸»åŠ›ä¼æ“Š"; }
                    else { stCmd = "READY"; reason = "é€²å…¥å°„ç¨‹"; }
                }

                // è™•ç† ENTRY é‚è¼¯
                let tpDisplay = "";
                if (stCmd === "ENTRY") {
                    if (!entryPrices[t.symbol]) entryPrices[t.symbol] = curPrice;
                    if (!statusTimestamps[t.symbol]) statusTimestamps[t.symbol] = Date.now();

                    // è¨ˆç®— TP
                    let fShift = Math.abs(Math.min(0, fundDelta));
                    let boost = (Math.min(fShift, 0.1) / 0.01) * 0.5 + (fShift > 0.1 ? ((fShift - 0.1) / 0.01) * 1.0 : 0);
                    boost += (Math.max(0, oiChange) / 5) * 1;
                    let tpPrice = entryPrices[t.symbol] * (1 + (boost / 100));
                    tpDisplay = `<span class="tp-label">(TP: ${tpPrice.toFixed(4)})</span>`;

                    // æ¨æ’­
                    if (audioEnabled && (!lastKnownTP[t.symbol] || tpPrice > lastKnownTP[t.symbol] * 1.005)) {
                        new Notification(`ğŸ¯ ${t.symbol} ç›®æ¨™ä¸Šèª¿`, { body: `TP: ${tpPrice.toFixed(4)} | 5mè³‡è²»åç§»: ${fundDelta.toFixed(3)}%` });
                        lastKnownTP[t.symbol] = tpPrice;
                        alertAudio.play();
                    }
                } else if (stCmd === "SCAN") {
                    delete entryPrices[t.symbol]; delete statusTimestamps[t.symbol]; delete lastKnownTP[t.symbol];
                }

                let duration = statusTimestamps[t.symbol] ? `${Math.floor((Date.now()-statusTimestamps[t.symbol])/60000)}m` : "";

                return { symbol: t.symbol, highVal, curPrice, dist, fund, oiChange, stCmd, reason, duration, tpDisplay, fundExpanding: fund < old.fund };
            });

            const res = (await Promise.all(promises)).filter(x => x !== null);
            const sortOrder = { 'READY': 0, 'ENTRY': 1, 'HOLD': 2, 'SCAN': 3 };
            res.sort((a,b) => (sortOrder[a.stCmd] - sortOrder[b.stCmd]) || (a.dist - b.dist));

            document.getElementById('list').innerHTML = res.slice(0, 25).map(c => `
                <tr>
                    <td><b>${c.symbol.replace('USDT','')}</b></td>
                    <td><div style="font-size:10px;color:#666">${c.highVal}</div>${c.curPrice}</td>
                    <td><span class="status-badge ${c.stCmd}">${c.stCmd}</span> <span style="font-size:10px;color:#888">${c.reason}</span> <span class="timer">${c.duration}</span></td>
                    <td class="${Math.abs(c.fund)>=0.05?'fund-warn':''}">${c.fund.toFixed(4)}% ${c.fundExpanding?'ğŸ”¥':''}</td>
                    <td><span class="${c.oiChange>0?'oi-up':'oi-down'}">${c.oiChange.toFixed(2)}%</span> ${c.tpDisplay}</td>
                    <td style="color:${c.dist<1.5?'#f0b90b':''}">${c.dist.toFixed(2)}%</td>
                </tr>
            `).join('');
        } catch (e) {}
    }
    setInterval(update, 15000); update();
</script>
</body>
</html>
