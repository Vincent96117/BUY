<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V178-X é‹¼éµæŒ‡æ®å®˜ V1.9.3 (æ°¸ä¸éºå¤±ç‰ˆ)</title>
    <style>
        :root { --bg: #0b0e11; --card: #181a20; --ready: #f0b90b; --entry: #f6465d; --hold: #2ebd85; --scan: #474d57; --text: #eaecef; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 950px; margin: 0 auto; }
        .control-panel { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }
        label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        select, input { background: #333; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .audio-btn { background: var(--ready); color: #000; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; height: 38px; }

        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 10px; overflow: hidden; }
        th { background: #1e2329; color: #848e9c; padding: 12px 8px; font-size: 12px; text-align: left; }
        td { padding: 12px 8px; border-bottom: 1px solid #2b2f36; }
        
        .manual-locked { background: rgba(246, 70, 93, 0.12) !important; border-left: 5px solid var(--entry) !important; }
        .auto-locked { background: rgba(46, 189, 133, 0.08); border-left: 5px solid var(--hold); }
        .symbol-btn { cursor: pointer; text-decoration: underline; color: #fff; font-weight: bold; font-size: 16px; }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; }
        
        .READY { background: rgba(240, 185, 11, 0.25); color: var(--ready); border: 1px solid var(--ready); animation: flash 1.5s infinite; }
        .ENTRY { background: var(--entry); color: #fff; border: 1px solid #fff; box-shadow: 0 0 10px var(--entry); animation: pulse 0.5s infinite alternate; }
        .SCAN { background: rgba(71, 77, 87, 0.1); color: var(--scan); border: 1px solid var(--scan); }

        .time-tag { font-size: 10px; color: #aaa; display: block; margin-top: 4px; font-family: monospace; }
        .unlock-btn { background: #444; color: #ff4d4d; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 9px; margin-left: 5px; }
        .fund-warn { color: #00ffff; text-shadow: 0 0 5px #00ffff; font-weight: bold; }
        
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }
    </style>
</head>
<body>

<div class="container">
    <div class="control-panel">
        <div>
            <label>çµæ§‹é€±æœŸ</label>
            <select id="lookbackDays">
                <option value="3" selected>3 å¤© (éˆæ•)</option>
                <option value="7">7 å¤© (ç©©å¥)</option>
            </select>
        </div>
        <div>
            <label>è³‡è²»é–€æª» (%)</label>
            <input type="number" id="fundThreshold" value="-0.03" step="0.01">
        </div>
        <div>
            <label>éŸ³æ•ˆæç¤º</label>
            <button id="enableAudio" class="audio-btn">ğŸ“¢ å•Ÿå‹•ç›£æ§</button>
        </div>
        <div style="text-align: right; font-size: 11px; color: #888;">
            é»æ“Šå¹£åæ‰‹å‹•é–å®š<br>
            å·²é–å®š: <span id="lockCount">0</span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>å¹£ç¨® (é–å®š)</th>
                <th>è§€å¯Ÿåƒ¹/ç•¶å‰åƒ¹</th>
                <th>æŒ‡ä»¤ (è§¸ç™¼æ™‚é–“)</th>
                <th>è³‡è²»</th>
                <th>å¼•åŠ›è·é›¢ â†“</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script>
    // éæ¿¾é»‘åå–® [cite: 2026-01-12]
    const blacklist = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT", "DOGEUSDT", "ADAUSDT", "TRXUSDT", "AVAXUSDT", "DOTUSDT", "SHIBUSDT", "TONUSDT", "LINKUSDT", "BCHUSDT", "NEARUSDT", "MATICUSDT", "LTCUSDT", "PEPEUSDT", "UNIUSDT", "ICPUSDT", "RENDERUSDT", "APTUSDT", "HBARUSDT", "ARBUSDT", "SUIUSDT"];
    
    let audioEnabled = false;
    let lockedSymbols = {}; // { 'SANDUSDT': { time: '...', manual: true, lastSt: '...' } }
    const readyAudio = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3');
    const entryAudio = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1100-modern.mp3');

    document.getElementById('enableAudio').addEventListener('click', function() {
        audioEnabled = !audioEnabled;
        this.innerText = audioEnabled ? "âœ… ç›£æ§ä¸­" : "ğŸ“¢ å•Ÿå‹•ç›£æ§";
        readyAudio.play().then(() => readyAudio.pause());
    });

    function toggleLock(symbol) {
        if (lockedSymbols[symbol]) delete lockedSymbols[symbol];
        else lockedSymbols[symbol] = { time: new Date().toLocaleTimeString(), manual: true, lastSt: 'SCAN' };
        update();
    }

    async function getHigh(symbol, days) {
        const limit = (days * 24) / 4;
        try {
            const r = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=4h&limit=${limit + 1}`);
            const d = await r.json();
            const history = d.slice(0, limit);
            return Math.max(...history.map(k => parseFloat(k[2])));
        } catch(e) { return 0; }
    }

    async function update() {
        try {
            const days = parseInt(document.getElementById('lookbackDays').value);
            const fundLimit = parseFloat(document.getElementById('fundThreshold').value);
            
            const tickerR = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const allTickers = await tickerR.json();
            
            // 1. å…ˆæŠŠæ‰€æœ‰æ‰‹å‹•é–å®šçš„å¹£ç¨®åˆ—å…¥æ¸…å–®ï¼Œä¸è«–æˆäº¤é‡
            let targetSymbols = new Set(Object.keys(lockedSymbols));
            
            // 2. åŠ å…¥æˆäº¤é‡å‰ 40 çš„å¹£ç¨®
            allTickers
                .filter(c => c.symbol.endsWith('USDT') && !blacklist.includes(c.symbol))
                .sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
                .slice(0, 40)
                .forEach(c => targetSymbols.add(c.symbol));

            let coinData = [];
            let playE = false, playR = false;

            for (let symbol of targetSymbols) {
                const ticker = allTickers.find(t => t.symbol === symbol);
                if (!ticker) continue;

                const highVal = await getHigh(symbol, days);
                const curPrice = parseFloat(ticker.lastPrice);
                const dist = ((highVal - curPrice) / curPrice * 100);
                
                const fundR = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${symbol}`);
                const fundD = await fundR.json();
                const fund = (parseFloat(fundD.lastFundingRate) * 100).toFixed(4);

                let stCmd = "SCAN";
                if (curPrice > highVal && fund <= fundLimit) { stCmd = "ENTRY"; playE = true; }
                else if (dist < 1.5 && dist > -0.5 && fund <= fundLimit) { stCmd = "READY"; playR = true; }

                // æ›´æ–°é–å®šæ¸…å–®ç‹€æ…‹
                if (stCmd === "READY" || stCmd === "ENTRY") {
                    if (!lockedSymbols[symbol]) {
                        lockedSymbols[symbol] = { time: new Date().toLocaleTimeString(), manual: false };
                    }
                }
                if (lockedSymbols[symbol]) lockedSymbols[symbol].lastSt = stCmd;

                coinData.push({ symbol, highVal, curPrice, dist, fund, stCmd });
            }

            if (audioEnabled) { if(playE) entryAudio.play(); else if(playR) readyAudio.play(); }

            // æ’åºï¼šæ‰‹å‹•é–å®š(2) > è‡ªå‹•é–å®š(1) > å¼•åŠ›è·é›¢
            coinData.sort((a, b) => {
                const aL = lockedSymbols[a.symbol] ? (lockedSymbols[a.symbol].manual ? 2 : 1) : 0;
                const bL = lockedSymbols[b.symbol] ? (lockedSymbols[b.symbol].manual ? 2 : 1) : 0;
                if (aL !== bL) return bL - aL;
                return a.dist - b.dist;
            });

            const listBody = document.getElementById('list');
            listBody.innerHTML = '';
            document.getElementById('lockCount').innerText = Object.keys(lockedSymbols).length;

            for (let coin of coinData) {
                const lockInfo = lockedSymbols[coin.symbol];
                const displaySt = lockInfo ? lockInfo.lastSt : coin.stCmd;
                // è³‡è²»æ­£è²  0.05 è®Šè‰² [cite: 2026-01-11]
                const fundClass = Math.abs(parseFloat(coin.fund)) >= 0.05 ? 'fund-warn' : '';

                const row = `
                    <tr class="${lockInfo ? (lockInfo.manual ? 'manual-locked' : 'auto-locked') : ''}">
                        <td>
                            <span class="symbol-btn" onclick="toggleLock('${coin.symbol}')">${coin.symbol.replace('USDT','')}</span>
                            <div style="font-size:10px; color:#666">${days}D High: ${coin.highVal}</div>
                        </td>
                        <td>
                            <div style="font-size:11px; color:#888; text-decoration: line-through;">${coin.highVal}</div>
                            <div style="font-family:monospace; font-weight:bold; color:#fff">${coin.curPrice}</div>
                        </td>
                        <td>
                            <span class="status-badge ${displaySt}">${displaySt}</span>
                            ${lockInfo ? `<span class="time-tag">â± ${lockInfo.time} ${lockInfo.manual?'ğŸ“Œ':''}<button class="unlock-btn" onclick="toggleLock('${coin.symbol}')">è§£é–</button></span>` : ''}
                        </td>
                        <td class="${fundClass}">${coin.fund}%</td>
                        <td style="font-weight:bold; color:${coin.dist < 1.5 ? 'var(--ready)' : '#888'}">${coin.dist.toFixed(2)}%</td>
                    </tr>
                `;
                listBody.insertAdjacentHTML('beforeend', row);
            }
        } catch (e) { console.error(e); }
    }

    setInterval(update, 30000);
    update();
</script>
</body>
</html>
