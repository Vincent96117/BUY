<!DOCTYPE html>
<html>
<head>
    <title>V2.6 é‹¼éµæŒ‡æ®å®˜ - POST çµ‚æ¥µç‰ˆ</title>
    <style>
        body { background: #111; color: #eee; font-family: "Microsoft JhengHei", sans-serif; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; background: #1a1a1a; }
        th, td { padding: 10px; border: 1px solid #333; text-align: left; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255, 235, 59, 0.1); }
        .ENTRY { color: #fff; background: #ff0000; font-weight: bold; animation: pulse 0.6s infinite; }
        .HOLD { color: #00ff00; font-weight: bold; background: rgba(0, 255, 0, 0.05); }
        @keyframes pulse { 0% { background: #ff0000; } 50% { background: #b71c1c; } 100% { background: #ff0000; } }
        button { padding: 10px 24px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-start { background: #d32f2f; color: white; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div style="font-size: 20px; font-weight: bold; color: #ff4444;">IRON COMMANDER V2.6</div>
        <button class="btn-start" id="startBtn" onclick="toggleSystem()">ğŸš€ å•Ÿå‹•ç›£æ§</button>
        <button style="background:#1976d2; color:white; margin-left:10px;" onclick="runDiagnostic()">ğŸ§ª æ¸¬è©¦ POST æ¨æ’­</button>
        <div id="statusUpdate" style="margin-left: auto; color: #00ffff;">3D High | POST Engine Active</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ä¸Šæ¦œæ™‚é–“</th>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3D é«˜é»</th>
                <th>è·é›¢ %</th>
                <th>è³‡è²» (Fund)</th>
                <th>ç‹€æ…‹</th>
                <th>åŸ·è¡Œå»ºè­°</th>
            </tr>
        </thead>
        <tbody id="radarBody"></tbody>
    </table>

<script>
    const BARK_KEY = "E96538f9eaef0eaec0fe65be1e6dc3738e08122150839671e3f654cd81633dcd";
    const BLACKLIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'];
    
    let isRunning = false;
    let notifiedStatus = {}; 
    let signalTimes = {}; 
    let lastOI = {}; 

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    // ã€æ›å€‹æ–¹å¼ã€‘æ”¹ç”¨ POST è«‹æ±‚ï¼Œå¾¹åº•é¿é–‹ URL 400 éŒ¯èª¤
    async function sendBark(title, body) {
        const url = "https://api.day.app/push";
        const payload = {
            device_key: BARK_KEY,
            title: title,
            body: body,
            group: "Trading",
            sound: "miners",
            icon: "https://bin.bnbstatic.com/static/images/common/favicon.ico"
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.code !== 200) console.error("POST å¤±æ•—:", result.message);
            else console.log("POST æ¨é€æˆåŠŸ");
        } catch (e) {
            console.error("ç™¼é€ç•°å¸¸:", e);
        }
    }

    function runDiagnostic() {
        speak("æ¸¬è©¦æœ€æ–°æ¨æ’­å¼•æ“");
        sendBark("é€£ç·šæ¸¬è©¦", "é€™æ˜¯ä½¿ç”¨ POST æ–¹å¼ç™¼é€çš„è¨Šæ¯ï¼Œç¢ºä¿ä¸å† 400 éŒ¯èª¤");
    }

    async function fetchData() {
        if (!isRunning) return;
        try {
            const [pRes, fRes, oRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/openInterest')
            ]);
            const prices = await pRes.json();
            const funds = await fRes.json();
            const ois = await oRes.json();

            let displayData = [];
            const targets = funds.filter(f => 
                f.symbol.endsWith('USDT') && !BLACKLIST.includes(f.symbol) && parseFloat(f.lastFundingRate) <= -0.0002
            );

            for (let f of targets) {
                // 3å¤©é«˜é»åˆ¤å®š (1d, limit 3)
                const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${f.symbol}&interval=1d&limit=3`);
                const klines = await kRes.json();
                if(!klines || klines.length < 3) continue;
                
                const threeDayHigh = Math.max(...klines.map(k => parseFloat(k[2])));
                const curPrice = parseFloat(prices.find(p => p.symbol === f.symbol).price);
                const fundRate = (parseFloat(f.lastFundingRate) * 100).toFixed(4);
                const dist = (((threeDayHigh - curPrice) / threeDayHigh) * 100);
                
                const currentOI = parseFloat(ois.find(o => o.symbol === f.symbol).openInterest);
                const oiChange = lastOI[f.symbol] ? ((currentOI - lastOI[f.symbol]) / lastOI[f.symbol] * 100) : 0;
                lastOI[f.symbol] = currentOI;

                let stCmd = "SCAN";
                let reason = "æƒæä¸­";

                // ENTRY é›™æ¢ä»¶ + READY + HOLD é‚è¼¯
                if (curPrice >= threeDayHigh) {
                    stCmd = "ENTRY"; 
                    reason = "ğŸ”´ çªç ´ 3D é«˜é»";
                } else if (dist <= 1.5 && dist > 0) {
                    if (oiChange > 0.8) { // OI ç•°å‹• 0.8% å³é»ç«
                        stCmd = "ENTRY";
                        reason = "ğŸ”´ ä¼æ“Šé»ç« (OI)";
                    } else {
                        stCmd = "READY";
                        reason = "ğŸŸ¡ é€²å…¥å°„ç¨‹";
                    }
                } else if (curPrice > threeDayHigh * 1.002) {
                    stCmd = "HOLD";
                    reason = "ğŸŸ¢ æŒçºŒç²åˆ©";
                }

                if (stCmd !== "SCAN") {
                    if (!signalTimes[f.symbol]) signalTimes[f.symbol] = new Date().toLocaleTimeString();
                    if (notifiedStatus[f.symbol] !== stCmd) {
                        // é€™è£¡å¯ä»¥å‚³é€å®Œæ•´ä¸­æ–‡ï¼ŒPOST ä¸æ€•å ±éŒ¯
                        sendBark(`${stCmd}: ${f.symbol}`, `è·é›¢: ${dist.toFixed(2)}% è³‡è²»: ${fundRate}%`);
                        speak(`${f.symbol} ${stCmd}`);
                        notifiedStatus[f.symbol] = stCmd;
                    }
                    displayData.push({ time: signalTimes[f.symbol], symbol: f.symbol, curPrice, highVal: threeDayHigh, dist: dist.toFixed(2), fundRate, stCmd, reason });
                } else {
                    delete signalTimes[f.symbol];
                    delete notifiedStatus[f.symbol];
                }
            }
            renderTable(displayData);
        } catch (e) { console.error("ç²å–å¤±æ•—"); }
    }

    function renderTable(data) {
        document.getElementById('radarBody').innerHTML = data.sort((a,b) => a.dist - b.dist).map(c => `
            <tr>
                <td style="color:#00ffff">${c.time}</td>
                <td><b>${c.symbol}</b></td>
                <td>${c.curPrice} / ${c.highVal}</td>
                <td style="color:#ff4444">${c.dist}%</td>
                <td style="color:#ff00ff">${c.fundRate}%</td>
                <td class="${c.stCmd}">${c.stCmd}</td>
                <td>${c.reason}</td>
            </tr>
        `).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢" : "ğŸš€ å•Ÿå‹•";
        if (isRunning) { setInterval(fetchData, 5000); fetchData(); }
    }
</script>
</body>
</html>
