<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä¸‰äººçµæ®ºåœ˜ V3.4-Pro</title>
    <style>
        :root { --bg: #0b0e11; --card: #181a20; --ready: #f0b90b; --entry: #f6465d; --hold: #2ebd85; --scan: #474d57; --text: #eaecef; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 10px; font-size: 13px; }
        .container { max-width: 1300px; margin: 0 auto; }
        .control-panel { background: #121212; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; }
        label { font-size: 12px; color: #888; }
        select, input { background: #1e2026; color: #fff; border: 1px solid #333; padding: 6px 12px; border-radius: 4px; }
        .audio-btn { background: #f0b90b; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; background: var(--card); }
        th { background: #121212; color: #848e9c; padding: 12px 8px; font-size: 11px; text-align: left; border-bottom: 1px solid #2b2f36; }
        td { padding: 12px 8px; border-bottom: 1px solid #2b2f36; }
        
        .status-badge { font-weight: bold; font-size: 11px; }
        .ENTRY { color: #f6465d; animation: pulse 1s infinite; }
        .READY { color: #f0b90b; }
        .HOLD { color: #2ebd85; }
        .SCAN { color: #474d57; }
        
        .fund-warn { color: #00ffff; text-shadow: 0 0 8px #00ffff; font-weight: bold; }
        .tp-label { color: #2ebd85; font-weight: bold; margin-left: 5px; border: 1px solid #2ebd8533; padding: 1px 3px; border-radius: 3px; font-size: 11px; }
        .timer { font-family: monospace; color: #888; font-size: 10px; margin-left: 4px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .pinned { background: rgba(240, 185, 11, 0.05); }
    </style>
</head>
<body>

<div class="container">
    <div class="control-panel">
        <div><label>è¿½è¹¤å¤©æ•¸</label>
            <select id="lookbackDays">
                <option value="3" selected>3 å¤©å‰é«˜</option>
                <option value="7">7 å¤©å‰é«˜</option>
            </select>
        </div>
        <div><label>è³‡è²»é–€æª» (%)</label>
            <input type="number" id="fundThreshold" value="-0.02" step="0.01">
        </div>
        <div><button id="enableAudio" class="audio-btn">âœ… ç›£æ§ä¸­</button></div>
        <div style="margin-left:auto; color:#444; font-size:11px;">ç³»çµ±æƒæ: <span id="lastTime">--:--:--</span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>å®šé¸</th>
                <th>å¹£ç¨®</th>
                <th>åƒ¹æ ¼ (å‰é«˜)</th>
                <th>ç‹€æ…‹ (åŸå› /æ™‚é–“)</th>
                <th>è³‡è²» (ğŸ”¥è¶¨å‹¢)</th>
                <th>æŒå€‰ OI (1mè®Šå‹•)</th>
                <th>å¼•åŠ›</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script>
    const blacklist = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];
    let historyData = {}; 
    let statusTimestamps = {}; 
    let entryPrices = {}; 
    let lastKnownTP = {};
    let pinnedSymbols = new Set(); // å­˜æ”¾å®šé¸çš„å¹£ç¨®

    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function update() {
        try {
            const days = parseInt(document.getElementById('lookbackDays').value);
            const fundLimit = parseFloat(document.getElementById('fundThreshold').value);
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const tickers = await r.json();
            
            const active = tickers.filter(x => x.symbol.endsWith('USDT') && !blacklist.includes(x.symbol) && parseFloat(x.quoteVolume) > 5000000)
                                 .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 40);

            document.getElementById('lastTime').innerText = new Date().toLocaleTimeString();
            let results = [];

            for (let t of active) {
                try {
                    await delay(65); 
                    const [fundR, kR, oiR] = await Promise.all([
                        fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${t.symbol}`).then(res => res.json()),
                        fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=4h&limit=${(days*6)+1}`).then(res => res.json()),
                        fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${t.symbol}`).then(res => res.json())
                    ]);

                    const curPrice = parseFloat(t.lastPrice);
                    const fund = parseFloat(fundR.lastFundingRate) * 100;
                    const oi = parseFloat(oiR.openInterest);
                    const highVal = Math.max(...kR.slice(0, days*6).map(k => parseFloat(k[2])));
                    const dist = ((highVal - curPrice) / curPrice * 100);

                    if (!historyData[t.symbol]) historyData[t.symbol] = [];
                    historyData[t.symbol].push({ fund, oi });
                    if (historyData[t.symbol].length > 20) historyData[t.symbol].shift();
                    const old = historyData[t.symbol][0];
                    const oiChange = ((oi - old.oi) / old.oi * 100);
                    const fundDelta = fund - old.fund;

                    let stCmd = "SCAN", reason = "æƒæ";
                    if (curPrice > highVal && fund <= fundLimit) {
                        stCmd = (oiChange > 1.0) ? "ENTRY" : "HOLD";
                        reason = (stCmd === "ENTRY") ? "çµæ§‹çªç ´" : "èƒ½é‡çºŒèˆª";
                    } else if (dist < 1.5 && fund <= fundLimit) {
                        stCmd = (oiChange > 5.0) ? "ENTRY" : "ä¸»åŠ›ä¼æ“Š";
                        reason = (stCmd === "ENTRY") ? "ä¸»åŠ›ä¼æ“Š" : "é€²å…¥å°„ç¨‹";
                    }

                    // å‹•æ…‹æ­¢ç›ˆ TP
                    let tpStr = "";
                    if (stCmd === "ENTRY") {
                        if (!entryPrices[t.symbol]) entryPrices[t.symbol] = curPrice;
                        let fShift = Math.abs(Math.min(0, fundDelta));
                        let boost = (Math.min(fShift, 0.1) / 0.01) * 0.5 + (fShift > 0.1 ? ((fShift - 0.1) / 0.01) * 1.0 : 0);
                        boost += (Math.max(0, oiChange) / 5) * 1;
                        let tpPrice = entryPrices[t.symbol] * (1 + (boost / 100));
                        tpStr = `<span class="tp-label">TP: ${tpPrice.toFixed(4)}</span>`;
                        
                        if (tpPrice > (lastKnownTP[t.symbol] || 0) * 1.005) {
                            if (Notification.permission === "granted") {
                                new Notification(`ğŸ¯ ${t.symbol} ç›®æ¨™åƒ¹æ›´æ–°`, { body: `ç›®æ¨™: ${tpPrice.toFixed(4)}` });
                                lastKnownTP[t.symbol] = tpPrice;
                            }
                        }
                    } else if (stCmd === "SCAN") {
                        delete entryPrices[t.symbol]; delete lastKnownTP[t.symbol];
                    }

                    if (stCmd !== "SCAN" && !statusTimestamps[t.symbol]) statusTimestamps[t.symbol] = Date.now();
                    let duration = statusTimestamps[t.symbol] ? `${Math.floor((Date.now()-statusTimestamps[t.symbol])/60000)}m` : "";

                    results.push({ symbol: t.symbol, highVal, curPrice, dist, fund, oiChange, stCmd, reason, duration, tpStr, fundExpanding: fund < old.fund, isPinned: pinnedSymbols.has(t.symbol) });
                } catch (e) {}
            }

            // æ’åºé‚è¼¯ï¼šå®šé¸å„ªå…ˆ > ç‹€æ…‹å„ªå…ˆ > å¼•åŠ›è·é›¢
            const sortOrder = { 'READY': 0, 'ENTRY': 1, 'HOLD': 2, 'SCAN': 3 };
            results.sort((a,b) => {
                if (a.isPinned !== b.isPinned) return b.isPinned - a.isPinned;
                return (sortOrder[a.stCmd] - sortOrder[b.stCmd]) || (a.dist - b.dist);
            });

            document.getElementById('list').innerHTML = results.map(c => `
                <tr class="${c.isPinned?'pinned':''}">
                    <td><input type="checkbox" ${c.isPinned?'checked':''} onchange="togglePin('${c.symbol}')"></td>
                    <td><b>${c.symbol.replace('USDT','')}</b></td>
                    <td><div style="font-size:10px;color:#666">${c.highVal}</div>${c.curPrice}</td>
                    <td><span class="status-badge ${c.stCmd}">${c.stCmd}</span> <span style="font-size:10px;color:#888">${c.reason}</span> <span class="timer">${c.duration}</span></td>
                    <td class="${Math.abs(c.fund)>=0.05?'fund-warn':''}">${c.fund.toFixed(4)}% ${c.fundExpanding?'ğŸ”¥':''}</td>
                    <td><span style="color:${c.oiChange>0?'#2ebd85':'#f6465d'}">${c.oiChange.toFixed(2)}%</span> ${c.tpStr}</td>
                    <td style="color:${c.dist<1.5?'#f0b90b':''}">${c.dist.toFixed(2)}%</td>
                </tr>
            `).join('');
        } catch (err) {}
    }

    function togglePin(symbol) {
        if (pinnedSymbols.has(symbol)) pinnedSymbols.delete(symbol);
        else pinnedSymbols.add(symbol);
        // ä¸ç­‰å¾…ä¸‹å€‹é€±æœŸï¼Œç«‹å³é‡ç¹ªåˆ—è¡¨ï¼ˆå¯é¸ï¼Œé€™è£¡äº¤çµ¦ 15s åˆ·æ–°ï¼‰
    }

    if (Notification.permission !== "granted") Notification.requestPermission();
    setInterval(update, 15000); update();
</script>
</body>
</html>
