<!DOCTYPE html>
<html>
<head>
    <title>V2.7 é‹¼éµæŒ‡æ®å®˜ - çµ‚æ¥µé–å®šç‰ˆ</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #333; text-align: left; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255, 235, 59, 0.1); }
        .ENTRY { color: #fff; background: #ff0000; font-weight: bold; animation: pulse 0.6s infinite; }
        .HOLD { color: #00ff00; font-weight: bold; background: rgba(0, 255, 0, 0.1); }
        .pinned { background: #332200 !important; border: 2px solid #ffeb3b !important; }
        @keyframes pulse { 0% { background: #ff0000; } 50% { background: #b71c1c; } 100% { background: #ff0000; } }
        button { padding: 5px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-pin { background: #555; color: white; margin-right: 5px; }
        .btn-pin.active { background: #ffeb3b; color: black; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div style="font-size: 20px; font-weight: bold; color: #ff4444;">V2.7 COMMANDER</div>
        <button style="background: #d32f2f; color: white; padding: 10px 20px;" onclick="toggleSystem()" id="startBtn">ğŸš€ å•Ÿå‹•ç›£æ§</button>
        <div id="status" style="color:#00ffff; font-weight:bold;">ç­‰å¾…å•Ÿå‹• (10s é »ç‡)</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>é‡˜é¸</th>
                <th>ä¸Šæ¦œæ™‚é–“</th>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3D é«˜é»</th>
                <th>è·é›¢ %</th>
                <th>è³‡è²»</th>
                <th>ç‹€æ…‹</th>
                <th>OI è®Šå‹•</th>
            </tr>
        </thead>
        <tbody id="radarBody"></tbody>
    </table>

<script>
    const BARK_KEY = "E96538f9eaef0eaec0fe65be1e6dc3738e08122150839671e3f654cd81633dcd";
    const BLACKLIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'];
    let isRunning = false, notifiedStatus = {}, signalTimes = {}, lastOI = {}, allData = {}, pinnedSymbols = new Set();

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    async function sendBark(title, body) {
        const t = title.replace(/[^a-zA-Z0-9]/g, "");
        const b = body.replace(/[^a-zA-Z0-9]/g, "");
        fetch(`https://api.day.app/${BARK_KEY}/${t}/${b}?group=Trade`).catch(e => {});
    }

    function togglePin(symbol) {
        if (pinnedSymbols.has(symbol)) pinnedSymbols.delete(symbol);
        else pinnedSymbols.add(symbol);
        render();
    }

    async function getSingleOI(symbol) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
            const data = await res.json();
            return parseFloat(data.openInterest);
        } catch (e) { return null; }
    }

    async function get3DHigh(symbol) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=3`);
            const klines = await res.json();
            return Math.max(...klines.map(k => parseFloat(k[2])));
        } catch (e) { return null; }
    }

    async function mainLoop() {
        if (!isRunning) return;
        const statusEl = document.getElementById('status');
        
        try {
            const [pRes, fRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const prices = await pRes.json(), funds = await fRes.json();

            const targets = funds.filter(f => 
                f.symbol.endsWith('USDT') && !BLACKLIST.includes(f.symbol) && parseFloat(f.lastFundingRate) <= -0.0002
            );

            for (let f of targets) {
                if (!allData[f.symbol]) {
                    const high = await get3DHigh(f.symbol);
                    if (high) allData[f.symbol] = { high };
                    else continue;
                }
                
                const currentOI = await getSingleOI(f.symbol);
                if (currentOI === null) continue;

                const threeDayHigh = allData[f.symbol].high;
                const curPrice = parseFloat(prices.find(p => p.symbol === f.symbol).price);
                const fundRate = (parseFloat(f.lastFundingRate) * 100).toFixed(4);
                const dist = (((threeDayHigh - curPrice) / threeDayHigh) * 100);
                const oiChange = lastOI[f.symbol] ? ((currentOI - lastOI[f.symbol]) / lastOI[f.symbol] * 100) : 0;
                lastOI[f.symbol] = currentOI;

                let oldStatus = notifiedStatus[f.symbol] || "SCAN";
                let stCmd = "SCAN";

                // --- é‹¼éµé–å®šåˆ¤å®šé‚è¼¯ ---
                // 1. å¦‚æœä¹‹å‰å·²ç¶“æ˜¯ ENTRY æˆ– HOLDï¼Œé€²å…¥ã€Œé–å®šæ¨¡å¼ã€
                if (oldStatus === "ENTRY" || oldStatus === "HOLD") {
                    // åªè¦åƒ¹æ ¼æ²’è·Œç ´ 3Dé«˜é» 1%ï¼Œä¸” OI æ²’æŠ½æ°´è¶…é 1.5%ï¼Œå°±ç¶­æŒ HOLD
                    if (curPrice >= threeDayHigh * 0.99 && oiChange > -1.5) {
                        stCmd = "HOLD";
                    } else {
                        stCmd = "SCAN"; // çœŸæ­£è·Œç ´æˆ–æŠ½æ°´ï¼Œç›´æ¥ç†„ç‡ˆ
                    }
                } 
                // 2. åˆå§‹åˆ¤å®š
                else {
                    if (curPrice >= threeDayHigh) stCmd = "ENTRY"; 
                    else if (dist <= 1.5 && dist > 0 && oiChange > 0.8) stCmd = "ENTRY";
                    else if (dist <= 1.5 && dist > 0) stCmd = "READY";
                }

                if (stCmd !== "SCAN") {
                    if (!signalTimes[f.symbol]) signalTimes[f.symbol] = new Date().toLocaleTimeString();
                    if (notifiedStatus[f.symbol] !== stCmd) {
                        // ç‹€æ…‹æå‡æ‰æ¨æ’­èˆ‡èªªè©± (READY -> ENTRY æˆ– SCAN -> READY)
                        sendBark(stCmd + f.symbol, "D" + dist.toFixed(2) + "F" + fundRate);
                        speak(f.symbol + stCmd);
                        notifiedStatus[f.symbol] = stCmd;
                    }
                    allData[f.symbol].row = { time: signalTimes[f.symbol], symbol: f.symbol, curPrice, high: threeDayHigh, dist: dist.toFixed(2), fundRate, stCmd, oiChange: oiChange.toFixed(2) };
                } else {
                    delete signalTimes[f.symbol];
                    delete notifiedStatus[f.symbol];
                    if(allData[f.symbol]) delete allData[f.symbol].row;
                }
            }
            render();
            statusEl.innerText = "âœ… é‹¼éµç›£æ§ä¸­ (10s)";
        } catch (e) { console.error(e); }
    }

    function render() {
        const body = document.getElementById('radarBody');
        const rows = Object.values(allData).filter(d => d.row).map(d => d.row);
        
        // é‡˜é¸æ’åºå„ªå…ˆï¼Œå…¶æ¬¡æŒ‰è·é›¢æ’åº
        const sortedRows = rows.sort((a, b) => {
            if (pinnedSymbols.has(a.symbol) && !pinnedSymbols.has(b.symbol)) return -1;
            if (!pinnedSymbols.has(a.symbol) && pinnedSymbols.has(b.symbol)) return 1;
            return a.dist - b.dist;
        });

        body.innerHTML = sortedRows.map(c => `
            <tr class="${pinnedSymbols.has(c.symbol) ? 'pinned' : ''}">
                <td><button class="btn-pin ${pinnedSymbols.has(c.symbol) ? 'active' : ''}" onclick="togglePin('${c.symbol}')">ğŸ“Œ</button></td>
                <td style="color:#00ffff">${c.time}</td>
                <td><b>${c.symbol}</b></td>
                <td>${c.curPrice} / ${c.high}</td>
                <td style="color:#ff4444">${c.dist}%</td>
                <td style="color:#ff00ff">${c.fundRate}%</td>
                <td class="${c.stCmd}">${c.stCmd}</td>
                <td>${c.oiChange}%</td>
            </tr>
        `).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢" : "ğŸš€ å•Ÿå‹•";
        if (isRunning) { mainLoop(); setInterval(mainLoop, 10000); }
    }
</script>
</body>
</html>
