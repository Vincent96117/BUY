<!DOCTYPE html>
<html>
<head>
    <title>ä¸‰äººçµæ®ºåœ˜ V3.1-Ultimate</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #333; text-align: left; }
        .SCAN { color: #666; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255, 235, 59, 0.1); }
        .ENTRY { color: #fff; background: #ff0000; font-weight: bold; animation: pulse 0.5s infinite; }
        .HOLD { color: #00ff00; font-weight: bold; background: rgba(0, 255, 0, 0.1); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        #status { margin-left: auto; color: #00ffff; font-weight: bold; }
        .tp-text { display: block; color: #00ff00; font-size: 11px; margin-top: 3px; font-weight: bold; border: 1px solid #00ff00; padding: 2px; border-radius: 3px; }
        .turbo-badge { font-size: 9px; background: #ff0000; color: white; padding: 1px 3px; border-radius: 3px; margin-left: 3px; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div style="font-size: 20px; font-weight: bold; color: #ffeb3b;">ä¸‰äººçµæ®ºåœ˜ V3.1-Ultimate</div>
        <button style="background: #d32f2f; color: white;" onclick="toggleSystem()" id="startBtn">ğŸš€ å•Ÿå‹•ç›£æ§</button>
        <div id="status">ç³»çµ±å°±ç·’</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / 3D é«˜é»</th>
                <th>è·é›¢ %</th>
                <th>è³‡è²»</th>
                <th>ç‹€æ…‹</th>
                <th>OI è®Šå‹• / 5s å‹•æ…‹TP</th>
            </tr>
        </thead>
        <tbody id="radarBody"></tbody>
    </table>

<script>
    const CONFIG = {
        PO_USER: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", 
        PO_TOKEN: "acyoe3sz15x4n91r1349fdcau7x6pw", 
        BLACKLIST: ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT']
    };

    let isRunning = false;
    let notifiedStatus = {}, lastOI = {}, allData = {}, entryPoints = {}, turboIntervals = {};

    async function sendPush(title, message) {
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(title));
        const params = new URLSearchParams({ token: CONFIG.PO_TOKEN, user: CONFIG.PO_USER, title: title, message: message, priority: "1", sound: "classical" });
        try { await fetch('https://api.pushover.net/1/messages.json', { method: 'POST', body: params.toString(), headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }); } catch (e) {}
    }

    // --- æ ¸å¿ƒ TP è¨ˆç®—ï¼šå« -2%=14% ä¿åº•æ©Ÿåˆ¶ ---
    function getTP(symbol, pNow, fNow, oiChg) {
        let b = entryPoints[symbol];
        if (!b) return "";
        
        // 1. ä¿åº•èƒ½é‡ (æ ¹æ“šé€²å ´æ™‚è³‡è²»æ·±åº¦)
        // æ”¹è‰¯ä¿‚æ•¸ï¼šæ¯ 0.1% æä¾› 0.65% åŠ æˆ (2.0/0.1 * 0.65 = 13 + åŸºç¤ 1 = 14%)
        let fundEnergy = Math.abs(b.f) / 0.1 * 0.65;
        let baseBoost = 1.0 + fundEnergy;

        // 2. å¾ŒçºŒè³‡è²»åç§»åŠ æˆ
        let fShift = Math.abs(parseFloat(fNow) - b.f);
        let extraFund = (fShift / 0.01 * 0.5);

        // 3. OI è®Šå‹•åŠ æˆ (å«çˆ†å€‰è£œå„Ÿ)
        let oiBoost = (oiChg >= 0) ? (oiChg / 5 * 1.0) : (Math.abs(oiChg) / 5 * 1.2);

        let total = baseBoost + extraFund + oiBoost;
        let target = b.p * (1 + (total / 100));
        return `<span class="tp-text">ğŸ¯TP: ${target.toFixed(4)}<span class="turbo-badge">5s</span></span>`;
    }

    async function runTurbo(symbol) {
        if (!isRunning || (notifiedStatus[symbol] !== "ENTRY" && notifiedStatus[symbol] !== "HOLD")) {
            clearInterval(turboIntervals[symbol]); delete turboIntervals[symbol]; return;
        }
        try {
            const [pRes, fRes, oRes] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${symbol}`),
                fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${symbol}`),
                fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`)
            ]);
            const p = await pRes.json(), f = await fRes.json(), o = await oRes.json();
            const price = parseFloat(p.price), fund = (parseFloat(f.lastFundingRate)*100).toFixed(4), oi = parseFloat(o.openInterest);
            const oiChg = lastOI[symbol] ? ((oi - lastOI[symbol]) / lastOI[symbol] * 100).toFixed(2) : 0;
            
            if(allData[symbol]) {
                allData[symbol].row.price = price; allData[symbol].row.fund = fund; allData[symbol].row.oiChange = oiChg;
                allData[symbol].row.tpTag = getTP(symbol, price, fund, oiChg);
                render();
            }
        } catch (e) {}
    }

    async function mainLoop() {
        if (!isRunning) return;
        try {
            const [pRes, fRes] = await Promise.all([ fetch('https://fapi.binance.com/fapi/v1/ticker/price'), fetch('https://fapi.binance.com/fapi/v1/premiumIndex') ]);
            const prices = await pRes.json(), funds = await fRes.json();
            const eligible = funds.filter(f => f.symbol.endsWith('USDT') && !CONFIG.BLACKLIST.includes(f.symbol) && Math.abs(parseFloat(f.lastFundingRate)) >= 0.0005).map(f => f.symbol);

            for (let symbol of eligible) {
                if (!allData[symbol]) {
                    const hRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=3`);
                    const hData = await hRes.json();
                    allData[symbol] = { high: Math.max(...hData.map(k => parseFloat(k[2]))) };
                }
                const oRes = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
                const oData = await oRes.json();
                const currentOI = parseFloat(oData.openInterest);

                const fI = funds.find(f => f.symbol === symbol), pI = prices.find(p => p.symbol === symbol);
                const price = parseFloat(pI.price), fund = (parseFloat(fI.lastFundingRate)*100).toFixed(4), high = allData[symbol].high;
                const dist = ((high - price) / high * 100).toFixed(2), oiChg = lastOI[symbol] ? ((currentOI - lastOI[symbol]) / lastOI[symbol] * 100).toFixed(2) : 0;
                lastOI[symbol] = currentOI;

                let st = "SCAN", old = notifiedStatus[symbol] || "SCAN";
                if ((old === "ENTRY" || old === "HOLD") && (price >= high * 0.99 && oiChg > -1.5)) st = "HOLD";
                else if (price >= high || (dist <= 1.5 && oiChg > 0.8)) st = "ENTRY";
                else if (dist <= 1.5) st = "READY";

                if (st === "ENTRY" || st === "HOLD") {
                    if (!entryPoints[symbol]) entryPoints[symbol] = { p: price, f: parseFloat(fund) };
                    if (!turboIntervals[symbol]) turboIntervals[symbol] = setInterval(() => runTurbo(symbol), 5000);
                } else { delete entryPoints[symbol]; }

                if (st !== old && st !== "SCAN") sendPush(`${st}: ${symbol}`, `åƒ¹:${price} è£œ:${fund}%`);
                notifiedStatus[symbol] = st;
                allData[symbol].row = { symbol, price, high, dist, fund, st, oiChange: oiChg, tpTag: getTP(symbol, price, fund, oiChg) };
            }
            render();
            document.getElementById('status').innerText = `ç›£æ§ä¸­... ${new Date().toLocaleTimeString()}`;
        } catch (e) {}
    }

    function render() {
        const rows = Object.values(allData).filter(d => d.row).map(d => d.row).sort((a, b) => a.dist - b.dist);
        document.getElementById('radarBody').innerHTML = rows.map(c => `
            <tr>
                <td><b>${c.symbol}</b></td>
                <td>${c.price} / ${c.high}</td>
                <td style="color:${c.dist < 0 ? '#00ff00' : '#ff4444'}">${c.dist}%</td>
                <td>${c.fund}%</td>
                <td class="${c.st}">${c.st}</td>
                <td>${c.oiChange}% ${c.tpTag || ''}</td>
            </tr>
        `).join('');
    }

    function toggleSystem() { isRunning = !isRunning; document.getElementById('startBtn').innerText = isRunning ? "ğŸ›‘ åœæ­¢" : "ğŸš€ å•Ÿå‹•"; if (isRunning) { mainLoop(); setInterval(mainLoop, 15000); } }
</script>
</body>
</html>
