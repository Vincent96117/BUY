<!DOCTYPE html>
<html>
<head>
    <title>V2.6 é‹¼éµæŒ‡æ®å®˜ - å®Œæ•´ç‰ˆ</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: "Microsoft JhengHei", sans-serif; margin: 20px; }
        .dashboard { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; background: #111; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        th, td { padding: 12px; border: 1px solid #222; text-align: left; }
        th { background: #1a1a1a; color: #888; font-size: 12px; }
        .READY { color: #ffeb3b; font-weight: bold; background: rgba(255, 235, 59, 0.1); }
        .ENTRY { color: #fff; background: #d32f2f; font-weight: bold; animation: pulse 0.8s infinite; }
        .HOLD { color: #00ff00; font-weight: bold; background: rgba(0, 255, 0, 0.05); }
        .timer { font-family: monospace; color: #00ffff; margin-left: 8px; font-size: 11px; }
        @keyframes pulse { 0% { background: #d32f2f; } 50% { background: #ff5252; } 100% { background: #d32f2f; } }
        button { padding: 10px 24px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; background: #d32f2f; color: white; transition: 0.3s; }
        button:hover { background: #ff5252; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div style="font-size: 18px; font-weight: bold; color: #ff4444;">IRON COMMANDER V2.6</div>
        <button id="startBtn" onclick="toggleSystem()">ğŸš€ å•Ÿå‹•å…¨åŠŸèƒ½ç›£æ§</button>
        <div id="statusUpdate" style="margin-left: auto; color: #00ffff;">ç³»çµ±å°±ç·’ | å·²é€£ç·š BARK</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>æ¨™çš„</th>
                <th>åƒ¹æ ¼ / å‰é«˜</th>
                <th>è·é›¢ %</th>
                <th>è³‡è²» (Fund)</th>
                <th>OI 1m è®Šå‹•</th>
                <th>ç‹€æ…‹</th>
                <th>åŸ·è¡Œå»ºè­°</th>
            </tr>
        </thead>
        <tbody id="radarBody"></tbody>
    </table>

<script>
    // --- æ ¸å¿ƒé…ç½® (å¡«å…¥ä½ çš„ Key) ---
    const BARK_KEY = "E96538f9eaef0eaec0fe65be1e6dc3738e08122150839671e3f654cd81633dcd";
    const BLACKLIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'BNBUSDT', 'BNXUSDT'];
    
    let isRunning = false;
    let historyOI = {}; // å„²å­˜æ­·å² OI æ•¸æ“š
    let notifiedStatus = {}; 
    let startTime = {}; // ç‡ˆè™Ÿè¨ˆæ™‚

    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    async function sendBark(title, body) {
        const url = `https://api.day.app/${BARK_KEY}/${encodeURIComponent(title)}/${encodeURIComponent(body)}?group=Trading&sound=miners&isArchive=1`;
        fetch(url).catch(e => console.error("Bark æ¨é€å¤±æ•—"));
    }

    async function fetchData() {
        if (!isRunning) return;
        try {
            // æŠ“å–ï¼š1.åƒ¹æ ¼ 2.è³‡è²» 3.24Hé«˜é» 4.æŒå€‰é‡(OI)
            const [pRes, fRes, tRes, oRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/price'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex'),
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/openInterest') // é€™è£¡é€šå¸¸éœ€è¦é€å€‹æŠ“å–ï¼Œç°¡åŒ–ç¤ºç¯„æ¡ç”¨ ticker é‚è¼¯
            ]);
            
            const prices = await pRes.json();
            const funds = await fRes.json();
            const tickers = await tRes.json();

            let displayData = [];

            // éæ¿¾é‚è¼¯
            funds.forEach(f => {
                if (!f.symbol.endsWith('USDT') || BLACKLIST.includes(f.symbol)) return;
                
                const fundRate = parseFloat(f.lastFundingRate);
                // æ¢ä»¶ï¼šè³‡è²»æ­£è²  0.05 éƒ½è·³å‡ºä¾†
                if (Math.abs(fundRate) < 0.0005) return;

                const curPrice = parseFloat(prices.find(p => p.symbol === f.symbol).price);
                const ticker = tickers.find(t => t.symbol === f.symbol);
                const highVal = parseFloat(ticker.highPrice);
                const dist = (((highVal - curPrice) / highVal) * 100).toFixed(2);
                
                // OI æ¨¡æ“¬é‚è¼¯ (å¯¦æˆ°ä¸­éœ€é€£ç·šå€‹åˆ¥ OI æ¥å£)
                const currentOI = parseFloat(ticker.volume); // é€™è£¡æš«ç”¨æˆäº¤é‡æ¨¡æ“¬å‹•èƒ½ï¼Œç¢ºä¿æ¼”ç¤ºæœ‰æ•¸æ“š
                if (!historyOI[f.symbol]) historyOI[f.symbol] = currentOI;
                const oiChange = (((currentOI - historyOI[f.symbol]) / historyOI[f.symbol]) * 100).toFixed(2);
                historyOI[f.symbol] = currentOI; // æ›´æ–°æ•¸æ“š

                let stCmd = "SCAN";
                let reason = "æƒæä¸­";

                // æ ¸å¿ƒåˆ¤å®šé‚è¼¯ (ä¸æ”¹å‹•)
                if (dist <= 1.5 && dist > 0) {
                    stCmd = "READY";
                    reason = "é€²å…¥å°„ç¨‹ï¼Œæº–å‚™ä¼æ“Š";
                } 
                
                if (curPrice >= highVal && oiChange > 1.0) {
                    stCmd = "ENTRY";
                    reason = "çµæ§‹çªç ´ (OIç¢ºèª)";
                } else if (dist <= 1.5 && oiChange > 5.0) {
                    stCmd = "ENTRY";
                    reason = "ä¸»åŠ›ä¼æ“Š (OIæš´å¢)";
                } else if (curPrice >= highVal) {
                    stCmd = "HOLD";
                    reason = "èƒ½é‡çºŒèˆªä¸­";
                }

                // æ¨æ’­é‚è¼¯ï¼šåªè¦æ˜¯ READY, ENTRY, HOLD ä¸”ç‹€æ…‹è®Šæ›´å°±æ¨
                if (stCmd !== "SCAN") {
                    if (notifiedStatus[f.symbol] !== stCmd) {
                        sendBark(`${stCmd}: ${f.symbol}`, `è³‡è²»: ${(fundRate*100).toFixed(4)}% | è·é›¢: ${dist}%`);
                        speak(`${f.symbol} ${stCmd}`);
                        notifiedStatus[f.symbol] = stCmd;
                    }
                    displayData.push({ symbol: f.symbol, curPrice, highVal, dist, fundRate: (fundRate*100).toFixed(4), oiChange, stCmd, reason });
                } else {
                    notifiedStatus[f.symbol] = "SCAN";
                }
            });

            renderTable(displayData);
        } catch (e) {
            console.log("åŸå¸‚é‹ä½œç•°å¸¸ï¼Œé‡æ–°é€£ç·šä¸­...");
        }
    }

    function renderTable(data) {
        const body = document.getElementById('radarBody');
        body.innerHTML = data.sort((a,b) => a.dist - b.dist).map(c => `
            <tr>
                <td><b>${c.symbol}</b></td>
                <td>${c.curPrice.toFixed(4)} / ${c.highVal.toFixed(4)}</td>
                <td>${c.dist}%</td>
                <td style="color:${c.fundRate < 0 ? '#ff00ff' : '#00ffff'}">${c.fundRate}%</td>
                <td style="color:#ff4444">${c.oiChange}%</td>
                <td class="${c.stCmd}">${c.stCmd}</td>
                <td>${c.reason}</td>
            </tr>
        `).join('');
    }

    function toggleSystem() {
        isRunning = !isRunning;
        const btn = document.getElementById('startBtn');
        btn.innerText = isRunning ? "ğŸ›‘ åœæ­¢ç›£æ§" : "ğŸš€ å•Ÿå‹•å…¨åŠŸèƒ½ç›£æ§";
        if (isRunning) {
            speak("åŸå¸‚é€£ç·šæˆåŠŸï¼Œå•Ÿå‹•é‹¼éµæŒ‡æ®å®˜ã€‚");
            setInterval(fetchData, 15000); 
        }
    }
</script>
</body>
</html>
