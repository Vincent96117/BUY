<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>V178-X é‹¼éµæŒ‡æ®å®˜ V2.1 (ç§‘å­¸æ•¸æ“šç©©å®šç‰ˆ)</title>
    <style>
        :root { --bg: #0b0e11; --card: #181a20; --ready: #f0b90b; --entry: #f6465d; --hold: #2ebd85; --scan: #474d57; --text: #eaecef; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .control-panel { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }
        label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        select, input { background: #333; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .audio-btn { background: var(--ready); color: #000; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .timer-bar { background: #1e2329; padding: 8px 15px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--ready); }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 10px; overflow: hidden; }
        th { background: #1e2329; color: #848e9c; padding: 12px 8px; font-size: 12px; text-align: left; }
        td { padding: 12px 8px; border-bottom: 1px solid #2b2f36; }
        .symbol-btn { cursor: pointer; text-decoration: underline; font-weight: bold; font-size: 16px; }
        .is-locked { color: #f0b90b !important; text-shadow: 0 0 8px rgba(240, 185, 11, 0.5); }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .READY { background: rgba(240, 185, 11, 0.2); color: var(--ready); }
        .ENTRY { background: var(--entry); color: #fff; animation: pulse 0.5s infinite alternate; }
        .HOLD { background: var(--hold); color: #fff; border: 1px solid #fff; box-shadow: 0 0 10px var(--hold); }
        .SCAN { color: var(--scan); }
        .fund-warn { color: #00ffff; text-shadow: 0 0 5px #00ffff; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
    </style>
</head>
<body>

<div class="container">
    <div class="control-panel">
        <div><label>é€±æœŸ</label><select id="lookbackDays"><option value="3" selected>3 å¤©</option><option value="7">7 å¤©</option></select></div>
        <div><label>è³‡è²»é–€æª» (%)</label><input type="number" id="fundThreshold" value="-0.02" step="0.01"></div>
        <div><label>éŸ³æ•ˆ</label><button id="enableAudio" class="audio-btn">ğŸ“¢ å•Ÿå‹•ç›£æ§</button></div>
    </div>

    <div class="timer-bar">
        <span>ç³»çµ±æ™‚é–“ï¼š<b id="lastUpdate">æ•¸æ“šåˆå§‹åŒ–ä¸­...</b></span>
        <span id="nextRefresh">ä¸‹æ¬¡åˆ·æ–°ï¼š15s</span>
    </div>

    <table>
        <thead><tr><th>å¹£ç¨® (é–å®š)</th><th>ç•¶å‰/å‰é«˜</th><th>ç‹€æ…‹</th><th>è³‡è²» (ğŸ”¥è¶¨å‹¢)</th><th>æŒå€‰ OI è®Šå‹•</th><th>å¼•åŠ›</th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script>
    const blacklist = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];
    let audioEnabled = false;
    let lockedSymbols = {};
    let historyData = {}; 
    let countdown = 15;
    const entryAudio = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1100-modern.mp3');

    function toggleLock(symbol) {
        lockedSymbols[symbol] = !lockedSymbols[symbol];
        updateUI();
    }

    document.getElementById('enableAudio').addEventListener('click', function() {
        audioEnabled = !audioEnabled;
        this.innerText = audioEnabled ? "âœ… ç›£æ§ä¸­" : "ğŸ“¢ å•Ÿå‹•ç›£æ§";
        entryAudio.play().then(() => entryAudio.pause());
    });

    setInterval(() => {
        countdown--;
        if (countdown <= 0) { countdown = 15; update(); }
        document.getElementById('nextRefresh').innerText = `ä¸‹æ¬¡åˆ·æ–°ï¼š${countdown}s`;
    }, 1000);

    async function update() {
        try {
            const days = parseInt(document.getElementById('lookbackDays').value);
            const fundLimit = parseFloat(document.getElementById('fundThreshold').value);
            
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const tickers = await r.json();
            const active = tickers.filter(x => x.symbol.endsWith('USDT') && !blacklist.includes(x.symbol) && parseFloat(x.quoteVolume) > 5000000)
                                 .sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 50);

            const now = new Date();
            document.getElementById('lastUpdate').innerText = now.toLocaleTimeString();

            let playE = false;
            const promises = active.map(async (t) => {
                try {
                    const [fundR, kR, oiR] = await Promise.all([
                        fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${t.symbol}`).then(res => res.json()),
                        fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${t.symbol}&interval=4h&limit=${(days*6)+1}`).then(res => res.json()),
                        fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${t.symbol}`).then(res => res.json())
                    ]);

                    const curPrice = parseFloat(t.lastPrice);
                    const fund = parseFloat(fundR.lastFundingRate) * 100;
                    const oi = parseFloat(oiR.openInterest);
                    const highVal = Math.max(...kR.slice(0, days*6).map(k => parseFloat(k[2])));
                    const dist = ((highVal - curPrice) / curPrice * 100);

                    if (!historyData[t.symbol]) historyData[t.symbol] = [];
                    historyData[t.symbol].push({ fund, oi });
                    if (historyData[t.symbol].length > 4) historyData[t.symbol].shift();

                    // æ•¸æ“šä¸è¶³ä¸€åˆ†é˜ï¼Œå…ˆä¸é¡¯ç¤ºè©²å¹£ç¨®ï¼Œé¿å… NaN
                    if (historyData[t.symbol].length < 4) return null;

                    const oldData = historyData[t.symbol][0];
                    const fundExpanding = fund < oldData.fund; 
                    const oiChange = ((oi - oldData.oi) / oldData.oi * 100);

                    let stCmd = "SCAN";
                    const fundOk = fund <= fundLimit;

                    if (curPrice > highVal && fundOk) {
                        if (fundExpanding || oiChange > 0.5 || Math.abs(oiChange) < 1) {
                            stCmd = "HOLD";
                        } else {
                            stCmd = "ENTRY";
                            playE = true;
                        }
                    } else if (dist < 1.5 && dist > -0.5 && fundOk) {
                        stCmd = "READY";
                    }

                    return { symbol: t.symbol, highVal, curPrice, dist, fund, oiChange, stCmd, fundExpanding };
                } catch (e) { return null; }
            });

            const results = (await Promise.all(promises)).filter(x => x !== null);
            if (audioEnabled && playE) entryAudio.play();

            window.currentResults = results;
            updateUI();
        } catch (e) {}
    }

    function updateUI() {
        if (!window.currentResults) return;
        const results = [...window.currentResults].sort((a, b) => {
            if (lockedSymbols[a.symbol] && !lockedSymbols[b.symbol]) return -1;
            if (!lockedSymbols[a.symbol] && lockedSymbols[b.symbol]) return 1;
            const s = { 'ENTRY': 0, 'HOLD': 1, 'READY': 2, 'SCAN': 3 };
            return s[a.stCmd] - s[b.stCmd] || a.dist - b.dist;
        });

        document.getElementById('list').innerHTML = results.slice(0, 30).map(c => `
            <tr>
                <td><span class="symbol-btn ${lockedSymbols[c.symbol]?'is-locked':''}" onclick="toggleLock('${c.symbol}')">${c.symbol.replace('USDT','')}</span></td>
                <td><div>${c.curPrice}</div><div style="font-size:10px;color:#666">H:${c.highVal}</div></td>
                <td><span class="status-badge ${c.stCmd}">${c.stCmd}</span></td>
                <td class="${Math.abs(c.fund)>=0.05?'fund-warn':''}">${c.fund.toFixed(4)}% ${c.fundExpanding?'ğŸ”¥':''}</td>
                <td style="color:${c.oiChange>0?'#2ebd85':'#f6465d'}">${c.oiChange>0?'+':''}${c.oiChange.toFixed(2)}%</td>
                <td style="color:${c.dist<1.5?'#f0b90b':''}">${c.dist.toFixed(2)}%</td>
            </tr>
        `).join('');
    }
    update();
</script>
</body>
</html>
